<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Fragment>

    <!-- Each consuming MSI must define Directory Id="service_folder"
         (e.g., ProgramFiles64Folder\Intel\PresentMon\Service). -->
    <DirectoryRef Id="service_folder">

      <!-- PresentMonService.exe (key file + Windows service) -->
      <Component Id="pmon_shared_service_component"
                 Guid="{45531AC0-CEB6-4DD0-B6B6-2BAD7F6AD01E}"
                 Win64="yes"
                 NeverOverwrite="no"
                 Permanent="no">
        <File Id="pmon_shared_service_exe"
              Name="$(var.PresentMonService.TargetFileName)"
              Source="$(var.PresentMonService.TargetPath)"
              KeyPath="yes"
              Checksum="yes"
              Vital="yes" />

        <ServiceInstall Id="PmSharedServiceInstall"
                        Name="PresentMonSharedService"
                        DisplayName="PresentMon Shared Service"
                        Description="Shared PresentMon service to collect metrics and expose them to client applications."
                        Start="auto"
                        Type="ownProcess"
                        ErrorControl="normal"
                        Vital="no" />
        <!-- Only handle service removal on uninstall - let RestartManager handle in-use files -->
        <ServiceControl Id="SharedPresentMonServiceControl"
                        Name="PresentMonSharedService"
                        Remove="uninstall"
                        Wait="no" />
        <RemoveFolder Id ="PresentMonSharedServiceUninstall"
                      Directory="service_folder"
                      On="uninstall"/>
      </Component>

      <!-- PresentMonAPI2.dll -->
      <Component Id="present_mon_shared_dll_component"
                 Guid="{BC2D2B30-9011-48E5-8592-ACC58CEFDF17}"
                 Win64="yes"
                 NeverOverwrite="no"
                 Permanent="no">
        <File Id="present_mon_shared_api_2_dll"
              Name="$(var.PresentMonAPI2.TargetFileName)"
              Source="$(var.PresentMonAPI2.TargetPath)"
              KeyPath="yes"
              Checksum="yes"
              Vital="yes" />
      </Component>

    </DirectoryRef>

    <!-- Smart service start - only if service is not already running -->
    <CustomAction Id="TryStartSharedService"
                  Directory="SystemFolder"
                  ExeCommand='cmd /c "sc query PresentMonSharedService | find "RUNNING" > nul || sc start PresentMonSharedService"'
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <InstallExecuteSequence>
        <!-- After InstallServices has registered the service (and StartServices would have run) -->
        <Custom Action="TryStartSharedService" After="StartServices">1</Custom>
    </InstallExecuteSequence>
      
    <!-- Group that consumers reference -->
    <ComponentGroup Id="service_files">
      <ComponentRef Id="pmon_shared_service_component" />
      <ComponentRef Id="present_mon_shared_dll_component" />
    </ComponentGroup>

  </Fragment>
</Wix>
